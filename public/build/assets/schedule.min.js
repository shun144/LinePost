function postImmediately(e){e.preventDefault();const t="即時配信を開始してよろしいですか?";if(!window.confirm(t))return!1;const a=document.getElementById("postImiCsrfToken").value;let d=$("#form_post_message"),n=new FormData(d.get(0));$.ajax({headers:{"X-CSRF-TOKEN":a},url:URL_MEDSSAGE_POST,method:"POST",contentType:!1,processData:!1,data:n});const l=$("#post_message");l.find(".content_form").val(""),l.find(".has_file").val("0"),l.find("input[type=file]").val(""),l.find(".image_preview").get(0).innerHTML="",l.find(".filename_view").val(""),l.modal("hide"),toastr.info("即時配信を開始しました。<br/> 状況は配信履歴一覧をご確認ください")}function submitAddSchedule(e){e.preventDefault();const t="スケジュールを作成してよろしいですか?";if(window.confirm(t)){const e=$("#addTemplateCsrfToken").val();let t=$("#form_add_schedule"),a=new FormData(t.get(0));modal_add_schedule.modal("hide"),$.ajax({headers:{"X-CSRF-TOKEN":e},url:URL_SCHEDULE_ADD,method:"POST",contentType:!1,processData:!1,data:a}).done(function(e){calendar.addEvent({id:e.id,title:e.title,start:e.start,backgroundColor:e.backgroundColor,borderColor:e.borderColor,allDay:e.allDay,content:e.content,plan_at:e.plan_at,images:e.images}),toastr.success("スケジュールを追加しました。")}).fail(function(e){toastr.error("スケジュール追加に失敗しました。")})}return!1}function submitEditSchedule(e){const t="スケジュールを更新してよろしいですか?";if(window.confirm(t)){edit_data.data("isChange","true");const e=$("#editScheduleCsrfToken").val();let t=$("#form_edit_schedule"),a=new FormData(t.get(0)),d=calendar.getEventById(a.get("message_id"));modal_edit_schedule.modal("hide"),$.ajax({headers:{"X-CSRF-TOKEN":e},url:URL_SCHEDULE_EDIT,method:"POST",contentType:!1,processData:!1,data:a}).done(function(e){const t=new Date(e.start.split(" ")[0]+" 00:00:00"),a=new Date(e.end);d.setStart(t),d.setEnd(a),d.setProp("title",e.title),d.setProp("backgroundColor",e.backgroundColor),d.setProp("borderColor",e.borderColor),d.setAllDay(e.allDay),d.setExtendedProp("content",e.content),d.setExtendedProp("plan_at",e.plan_at),d.setExtendedProp("images",e.images),toastr.success("スケジュールを更新しました。")}).fail(function(e){toastr.error("スケジュール更新に失敗しました。")})}return!1}function submitDeleteSchedule(e){e.preventDefault();const t="スケジュールを削除してよろしいですか?";if(window.confirm(t)){const e=$("#delScheduleCsrfToken").val();let t=$("#form_del_schedule"),a=new FormData(t.get(0));$("#edit_schedule").modal("hide"),$.ajax({headers:{"X-CSRF-TOKEN":e},url:URL_SCHEDULE_DEL,method:"POST",contentType:!1,processData:!1,data:a}).done(function(e){calendar.getEventById(e).remove(),toastr.success("スケジュールを削除しました。")}).fail(function(e){toastr.error("スケジュール削除に失敗しました。")})}return!1}function ini_events(e){e.each(function(){$(this).draggable({scroll:!0,helper:"clone",zIndex:999,revert:!0,revertDuration:0})})}function preview_image(e){let t=e.target,a=$(t).closest(".input-group"),d=a.siblings(".image_preview"),n=a.children("input.filename_view"),l=a.find(".image_form"),i=a.find(".has_file");if(d.empty(),1!=t.files.length)return i.val("0"),n.val(""),l.val(""),!1;{const e=t.files[0];if(-1!==["image/jpeg","image/png"].indexOf(e.type)){let t=new FileReader;t.onload=function(e){d.append('<img src="'+e.target.result+'">')},t.readAsDataURL(e),n.val(e.name),i.val("1")}else n.val(""),i.val("0"),l.val("")}}function validatePostMsgInput(e,t){const a=$(e),d=a.find("textarea.content_form"),n=a.find(".content_feedback");let l=!1;d.val()||(n.text("必須項目です"),d.addClass("is-invalid"),l=!0),d.val().length>1e3&&(n.text("入力可能文字数は1000文字です"),d.addClass("is-invalid"),l=!0),l||$(t).submit()}function validateTemplateInput(e,t){const a=$(e),d=a.find("input.title_form"),n=a.find(".title_feedback"),l=a.find("textarea.content_form"),i=a.find(".content_feedback");let o=!1;d.val()||(n.text("必須項目です"),d.addClass("is-invalid"),o=!0),d.val().length>50&&(n.text("入力可能文字数は50文字です"),d.addClass("is-invalid"),o=!0),l.val()||(i.text("必須項目です"),l.addClass("is-invalid"),o=!0),l.val().length>1e3&&(i.text("入力可能文字数は1000文字です"),l.addClass("is-invalid"),o=!0),o||$(t).submit()}function validateScheduleInput(e,t){const a=$(e),d=a.find("input.title_form"),n=a.find(".title_feedback"),l=a.find("textarea.content_form"),i=a.find(".content_feedback"),o=a.find("input.datetime_form"),s=a.find(".datetime_feedback");let r=!1;o.val()||(s.text("必須項目です"),o.addClass("is-invalid"),r=!0),d.val()||(n.text("必須項目です"),d.addClass("is-invalid"),r=!0),d.val().length>50&&(n.text("入力可能文字数は50文字です"),d.addClass("is-invalid"),r=!0),l.val()||(i.text("必須項目です"),l.addClass("is-invalid"),r=!0),l.val().length>1e3&&(i.text("入力可能文字数は1000文字です"),l.addClass("is-invalid"),r=!0),r||$(t).submit()}let Calendar=FullCalendar.Calendar,Draggable=FullCalendar.Draggable,containerEl=document.getElementById("external-events"),checkbox=document.getElementById("drop-remove"),calendarEl=document.getElementById("calendar"),viewMonth=null,modal_add_schedule=$("#add_schedule"),modal_edit_schedule=$("#edit_schedule"),modal_edit_template=$("#edit_template"),add_data=$("#tmp_add_schedule_data"),edit_data=$("#tmp_edit_schedule_data"),edit_temp=$("#tmp_edit_template_data");const URL_ROOT=$(location).attr("origin"),URL_STORAGE=URL_ROOT+"/storage/owner/image/template",URL_DASHBOARD=URL_ROOT+"/dashboard",URL_MEDSSAGE_POST=URL_DASHBOARD+"/post",URL_SCHEDULE_GET=URL_DASHBOARD+"/schedule-get",URL_SCHEDULE_ADD=URL_DASHBOARD+"/schedule-add",URL_SCHEDULE_EDIT=URL_DASHBOARD+"/schedule-edit",URL_SCHEDULE_DEL=URL_DASHBOARD+"/schedule-del",URL_TEMPLATE_GET=URL_DASHBOARD+"/template-get";modal_edit_template.on("show.bs.modal",function(){const e=edit_temp.data("tempId");let t=templateMessages.find(t=>t.id==e);modal_edit_template.find(".msg_id").val(t.id),modal_edit_template.find(".title_form").val(t.title),modal_edit_template.find(".content_form").val(t.content);let a=modal_edit_template.find("[data-color='"+t.title_color+"']").get(0);a.checked=!0,a.dispatchEvent(new Event("change"));let d=modal_edit_template.find(".image_preview").get(0),n=modal_edit_template.find(".filename_view"),l=modal_edit_template.find(".img_id"),i="0";d.innerHTML="",n.val(""),l.val(""),modal_edit_template.find("input[type=file]").val("");const o=t.images[0];if(void 0!==o){i="1";const e=document.createElement("img");e.src=URL_STORAGE+"/"+o.save_name,d.appendChild(e),n.val(o.org_name),l.val(o.image_id)}modal_edit_template.find(".has_file").val(i)}),modal_add_schedule.on("show.bs.modal",function(){const e=new Date(add_data.data("viewDate")),t=e.getFullYear(),a=("00"+Number(e.getMonth()+1)).slice(-2),d=("00"+Number(e.getDate())).slice(-2);modal_add_schedule.find(".datetime_form").val(t+"-"+a+"-"+d),modal_add_schedule.find(".hh_form").val("00"),modal_add_schedule.find(".mm_form").val("00");let n=modal_add_schedule.find(".image_preview").get(0),l=modal_add_schedule.find(".filename_view"),i=modal_add_schedule.find(".img_id"),o="0";n.innerHTML="",l.val(""),i.val(""),modal_add_schedule.find("input[type=file]").val("");const s=add_data.data("tempId");if(""!=s){let e=templateMessages.find(e=>e.id==s);modal_add_schedule.find(".msg_id").val(e.id),modal_add_schedule.find(".title_form").val(e.title),modal_add_schedule.find(".content_form").val(e.content);let t=modal_add_schedule.find("[data-color='"+e.title_color+"']").get(0);t.checked=!0,t.dispatchEvent(new Event("change"));const a=e.images[0];if(void 0!==a){o="1";const e=document.createElement("img");e.src=URL_STORAGE+"/"+a.save_name,n.appendChild(e),l.val(a.org_name),i.val(a.image_id)}}else{modal_add_schedule.find(".msg_id").val(""),modal_add_schedule.find(".title_form").val(""),modal_add_schedule.find(".content_form").val("");let e=modal_add_schedule.find("[data-color='#E60012']").get(0);e.checked=!0,e.dispatchEvent(new Event("change"))}modal_add_schedule.find(".has_file").val(o)}),modal_edit_schedule.on("show.bs.modal",function(){const e=edit_data.data("msgId");let t=calendar.getEventById(e);const a=new Date(edit_data.data("viewDate")),d=a.getFullYear(),n=("00"+Number(a.getMonth()+1)).slice(-2),l=a.getDate(),i=new Date(t.extendedProps.plan_at),o=i.getHours().toString().padStart(2,"0"),s=i.getMinutes().toString().padStart(2,"0");modal_edit_schedule.find(".datetime_form").val(d+"-"+n+"-"+l),modal_edit_schedule.find(".hh_form").val(o),modal_edit_schedule.find(".mm_form").val(s),modal_edit_schedule.find(".msg_id").val(t.id);let r=modal_edit_schedule.find("[data-color='"+t.backgroundColor+"']").get(0);r.checked=!0,r.dispatchEvent(new Event("change")),modal_edit_schedule.find(".title_form").val(t.title),modal_edit_schedule.find(".content_form").val(t.extendedProps.content);let _=modal_edit_schedule.find(".image_preview").get(0),m=modal_edit_schedule.find(".filename_view"),c="0";_.innerHTML="",m.val("");const u=t.extendedProps.images[0];if(void 0!==u){c="1";const e=document.createElement("img");e.src=URL_STORAGE+"/"+u.save_name,_.appendChild(e),m.val(u.org_name)}modal_edit_schedule.find(".has_file").val(c)}),modal_edit_schedule.on("hide.bs.modal",function(){if("true"!=edit_data.data("isChange").toLowerCase()){const e=modal_edit_schedule.find(".msg_id").val();let t=calendar.getEventById(e);t.setStart(edit_data.data("oldStart")),t.setEnd(edit_data.data("oldEnd"))}});let templateMessages=null;$.ajax({url:URL_TEMPLATE_GET,type:"get"}).then(function(e){templateMessages=e},function(){console.error("読み込み失敗")}),$(".external-event").click(function(){edit_temp.data("tempId",$(this).data("msgid")),modal_edit_template.modal("show")}),new Draggable(containerEl,{itemSelector:".external-event",eventData:function(e){return{id:e.dataset.msgid,title:e.innerText,backgroundColor:window.getComputedStyle(e,null).getPropertyValue("background-color"),borderColor:window.getComputedStyle(e,null).getPropertyValue("background-color"),textColor:window.getComputedStyle(e,null).getPropertyValue("color")}}}),ini_events($("#external-events div.external-event"));let calendar=new Calendar(calendarEl,{timeZone:"local",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth"},themeSystem:"bootstrap",locale:"ja",businessHours:!0,editable:!0,droppable:!0,eventOrderStrict:!0,eventOrder:"plan_at",events:[],datesSet:e=>{viewMonth!=e.view.title&&(viewMonth=e.view.title,$.ajax({headers:{"X-CSRF-TOKEN":$("#calendarToken").text()},url:URL_SCHEDULE_GET,method:"POST",data:{start_date:e.start.valueOf(),end_date:e.end.valueOf()}}).done(function(e){calendar.removeAllEvents(),calendar.setOption("events",e)}))},eventResize:e=>{e.event.setEnd(e.oldEvent.end)},dateClick:e=>{add_data.data("tempId",""),add_data.data("viewDate",e.date),modal_add_schedule.modal("show")},eventClick:e=>{edit_data.data("msgId",e.event.id),edit_data.data("isChange","false"),edit_data.data("oldStart",e.event.start),edit_data.data("oldEnd",e.event.end),edit_data.data("viewDate",e.event.start),modal_edit_schedule.modal("show")},eventDrop:e=>{edit_data.data("msgId",e.event.id),edit_data.data("isChange","false"),edit_data.data("oldStart",e.oldEvent.start),edit_data.data("oldEnd",e.oldEvent.end),edit_data.data("viewDate",e.event.start),modal_edit_schedule.modal("show")},eventReceive:function(e){add_data.data("tempId",e.draggedEl.getAttribute("data-msgid")),add_data.data("viewDate",e.event.start),modal_add_schedule.modal("show"),e.event.remove()}});calendar.render(),$(document).on("click",".btn_del_file",function(e){let t=e.target,a=$(t).closest(".input-group"),d=a.siblings(".image_preview"),n=a.children("input.filename_view"),l=$(t).next();l.val("0");let i=a.find(".image_form");i.val(null),d.empty(),n.val(null)}),$(document).on("change",".image_form",function(e){preview_image(e)}),$(document).on("keydown",".title_form",function(e){$(e.target).removeClass("is-invalid")}),$(document).on("keydown",".content_form",function(e){$(e.target).removeClass("is-invalid")}),$(document).on("keydown",".datetime_form",function(e){$(e.target).removeClass("is-invalid")}),$(document).on("click",".btnPostImi",function(e){e.preventDefault(),validatePostMsgInput("#post_message","#form_post_message")}),$("#post_message").on("hidden.bs.modal",function(e){const t=$(e.target);t.find("textarea.content_form").removeClass("is-invalid")}),$(document).on("click",".btn_add_template",function(e){e.preventDefault(),validateTemplateInput("#add_template","#form_add_template")}),$("#add_template").on("hidden.bs.modal",function(e){const t=$(e.target);t.find("input.title_form").removeClass("is-invalid"),t.find("textarea.content_form").removeClass("is-invalid")}),$(document).on("click",".btn_edit_template",function(e){e.preventDefault(),validateTemplateInput("#edit_template","#form_edit_template")}),$("#edit_template").on("hidden.bs.modal",function(e){const t=$(e.target);t.find("input.title_form").removeClass("is-invalid"),t.find("textarea.content_form").removeClass("is-invalid")}),$(document).on("click",".btn_add_schedule",function(e){e.preventDefault(),validateScheduleInput("#add_schedule","#form_add_schedule")}),$("#add_schedule").on("hidden.bs.modal",function(e){const t=$(e.target);t.find("input.title_form").removeClass("is-invalid"),t.find("textarea.content_form").removeClass("is-invalid"),t.find("input.datetime_form").removeClass("is-invalid")}),$(document).on("click",".btn_edit_schedule",function(e){e.preventDefault(),validateScheduleInput("#edit_schedule","#form_edit_schedule")}),$("#edit_schedule").on("hidden.bs.modal",function(e){const t=$(e.target);t.find("input.title_form").removeClass("is-invalid"),t.find("textarea.content_form").removeClass("is-invalid"),t.find("input.datetime_form").removeClass("is-invalid")});